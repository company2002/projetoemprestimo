<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área do Cliente - Sistema de Empréstimos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        .dashboard {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }

        .welcome-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .emprestimos-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .emprestimo-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .emprestimo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .parcelas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .parcela-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }

        .parcela-card.paga {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .parcela-card.pendente {
            background: #fff3cd;
            border-color: #ffeeba;
        }

        .parcela-card.atrasada {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-em-dia {
            background: #d4edda;
            color: #155724;
        }

        .status-atrasado {
            background: #f8d7da;
            color: #721c24;
        }

        .status-quitado {
            background: #cce5ff;
            color: #004085;
        }

        .upload-comprovante {
            margin-top: 10px;
        }

        .upload-comprovante input[type="file"] {
            display: none;
        }

        .upload-comprovante label {
            background: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="welcome-section">
            <h1>Bem-vindo(a), <span id="nomeCliente">Cliente</span></h1>
            <p>Aqui você pode acompanhar seus empréstimos e pagamentos</p>
        </div>

        <div class="status-cards">
            <div class="status-card">
                <h3>Total de Empréstimos</h3>
                <div id="totalEmprestimos">0</div>
            </div>
            <div class="status-card">
                <h3>Valor Total Devido</h3>
                <div id="valorTotalDevido">R$ 0,00</div>
            </div>
            <div class="status-card">
                <h3>Próximo Vencimento</h3>
                <div id="proximoVencimento">Nenhum</div>
            </div>
            <div class="status-card">
                <h3>Score</h3>
                <div id="scoreCliente">0</div>
            </div>
        </div>

        <div class="emprestimos-section">
            <h2>Meus Empréstimos</h2>
            <div id="listaEmprestimos">
                <!-- Empréstimos serão inseridos aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de Pagamento -->
    <div id="modalPagamento" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Realizar Pagamento</h2>
            <div id="detalhesPagamento"></div>
            <form id="formPagamento">
                <div class="form-group">
                    <label>Forma de Pagamento</label>
                    <select id="formaPagamento" required>
                        <option value="pix">PIX</option>
                        <option value="boleto">Boleto</option>
                        <option value="transferencia">Transferência</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Comprovante</label>
                    <input type="file" id="comprovante" accept="image/*,.pdf" required>
                </div>
                <button type="submit" class="btn btn-primary">Enviar Pagamento</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://sistema-emprestimo.onrender.com';
        let clienteData = null;

        // Verificar autenticação
        function verificarAuth() {
            const token = localStorage.getItem('clienteToken');
            if (!token) {
                window.location.href = 'cadastro.html';
                return;
            }
            clienteData = JSON.parse(localStorage.getItem('clienteData'));
            document.getElementById('nomeCliente').textContent = clienteData.nome;
        }

        // Carregar dados do cliente
        async function carregarDados() {
            try {
                const response = await fetch(`${API_URL}/api/clientes/${clienteData.id}/emprestimos`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('clienteToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    atualizarDashboard(data);
                    renderizarEmprestimos(data.emprestimos);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados');
            }
        }

        // Atualizar dashboard
        function atualizarDashboard(data) {
            document.getElementById('totalEmprestimos').textContent = data.total_emprestimos;
            document.getElementById('valorTotalDevido').textContent = formatarMoeda(data.valor_total_devido);
            document.getElementById('proximoVencimento').textContent = data.proximo_vencimento ? formatarData(data.proximo_vencimento) : 'Nenhum';
            document.getElementById('scoreCliente').textContent = data.score;
        }

        // Renderizar empréstimos
        function renderizarEmprestimos(emprestimos) {
            const container = document.getElementById('listaEmprestimos');
            container.innerHTML = '';

            emprestimos.forEach(emp => {
                const card = document.createElement('div');
                card.className = 'emprestimo-card';
                
                const statusClass = emp.status_pagamento === 'em_dia' ? 'status-em-dia' : 
                                  emp.status_pagamento === 'atrasado' ? 'status-atrasado' : 
                                  'status-quitado';

                card.innerHTML = `
                    <div class="emprestimo-header">
                        <h3>Empréstimo #${emp.id}</h3>
                        <span class="status-badge ${statusClass}">
                            ${emp.status_pagamento.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    <div>
                        <p>Valor: ${formatarMoeda(emp.valor)}</p>
                        <p>Total com Juros: ${formatarMoeda(emp.total)}</p>
                        <p>Parcelas Pagas: ${emp.parcelas_pagas}/${emp.parcelas}</p>
                        <p>Próximo Vencimento: ${formatarData(emp.proxima_parcela)}</p>
                    </div>
                    <div class="parcelas-grid">
                        ${renderizarParcelas(emp.pagamentos)}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Renderizar parcelas
        function renderizarParcelas(pagamentos) {
            return pagamentos.map(pag => {
                const status = pag.status === 'pago' ? 'paga' :
                             new Date(pag.data_vencimento) < new Date() ? 'atrasada' : 'pendente';
                
                return `
                    <div class="parcela-card ${status}">
                        <div>Parcela ${pag.numero_parcela}</div>
                        <div>${formatarMoeda(pag.valor_parcela)}</div>
                        <div>${formatarData(pag.data_vencimento)}</div>
                        ${status === 'pendente' || status === 'atrasada' ? `
                            <button onclick="abrirModalPagamento(${pag.id})" class="btn btn-small">
                                Pagar
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Modal de pagamento
        function abrirModalPagamento(pagamentoId) {
            const modal = document.getElementById('modalPagamento');
            modal.style.display = 'block';
            modal.dataset.pagamentoId = pagamentoId;
        }

        // Fechar modal
        document.querySelector('.close').onclick = function() {
            document.getElementById('modalPagamento').style.display = 'none';
        }

        // Enviar pagamento
        document.getElementById('formPagamento').onsubmit = async function(e) {
            e.preventDefault();
            
            const pagamentoId = document.getElementById('modalPagamento').dataset.pagamentoId;
            const formData = new FormData();
            formData.append('forma_pagamento', document.getElementById('formaPagamento').value);
            formData.append('comprovante', document.getElementById('comprovante').files[0]);

            try {
                const response = await fetch(`${API_URL}/api/pagamentos/${pagamentoId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('clienteToken')}`
                    },
                    body: formData
                });

                if (response.ok) {
                    alert('Pagamento enviado com sucesso! Aguarde a confirmação.');
                    document.getElementById('modalPagamento').style.display = 'none';
                    carregarDados();
                } else {
                    alert('Erro ao enviar pagamento');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar pagamento');
            }
        }

        // Funções auxiliares
        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }

        // Inicialização
        verificarAuth();
        carregarDados();
    </script>
</body>
</html> 