<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área do Cliente - Sistema de Empréstimos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="src/styles/main.css">
    <style>
        .dashboard {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }

        .welcome-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .emprestimos-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .emprestimo-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .emprestimo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .parcelas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .parcela-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }

        .parcela-card.paga {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .parcela-card.pendente {
            background: #fff3cd;
            border-color: #ffeeba;
        }

        .parcela-card.atrasada {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-em-dia {
            background: #d4edda;
            color: #155724;
        }

        .status-atrasado {
            background: #f8d7da;
            color: #721c24;
        }

        .status-quitado {
            background: #cce5ff;
            color: #004085;
        }

        .status-aprovado {
            background: #cce5ff;
            color: #004085;
        }

        .status-recusado {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }

        .tipo-cliente {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }

        .tipo-PG {
            background: #28a745;
            color: white;
        }

        .tipo-NaoPG {
            background: #6c757d;
            color: white;
        }

        .upload-comprovante {
            margin-top: 10px;
        }

        .upload-comprovante input[type="file"] {
            display: none;
        }

        .upload-comprovante label {
            background: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 24px;
        }

        .nivel-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nivel-card {
            text-align: center;
            padding: 20px;
        }

        .nivel-icone {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .progresso-nivel {
            height: 20px;
            background: #eee;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }

        .barra-progresso {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .beneficios-container {
            margin-top: 20px;
        }

        .beneficios-container ul {
            list-style: none;
            padding: 0;
        }

        .beneficios-container li {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .medalhas-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .medalhas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .medalha-card {
            text-align: center;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .medalha-card:hover {
            transform: translateY(-5px);
        }

        .medalha-card.bloqueada {
            opacity: 0.5;
        }

        .medalha-icone {
            font-size: 32px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="welcome-section">
            <h1>Bem-vindo(a), <span id="nomeCliente">Cliente</span>
                <span id="tipoCliente" class="tipo-cliente"></span>
            </h1>
            <p>Aqui você pode acompanhar seus empréstimos e pagamentos</p>
        </div>

        <div class="nivel-container">
            <h2>Seu Nível</h2>
            <div class="nivel-card" id="nivelCard">
                <i class="fas fa-crown nivel-icone"></i>
                <h3 id="nivelNome">Carregando...</h3>
                <div class="progresso-nivel">
                    <div class="barra-progresso" id="progressoNivel"></div>
                </div>
                <p>Próximo nível em: <span id="pontosProximo">0</span> pontos</p>
            </div>

            <div class="beneficios-container">
                <h3>Seus Benefícios</h3>
                <ul id="listaBeneficios">
                    <li><i class="fas fa-percentage"></i> Desconto nos juros: <span id="descontoJuros">0%</span></li>
                    <li><i class="fas fa-chart-line"></i> Multiplicador de margem: <span id="multiplicadorMargem">1x</span></li>
                    <li><i class="fas fa-clock"></i> Tempo de análise: <span id="tempoAnalise">24h</span></li>
                </ul>
            </div>
        </div>

        <div class="medalhas-container">
            <h2>Suas Conquistas</h2>
            <div class="medalhas-grid" id="medalhasGrid">
                <!-- Medalhas serão inseridas aqui via JavaScript -->
            </div>
        </div>

        <div class="status-cards">
            <div class="status-card">
                <h3>Total de Empréstimos</h3>
                <div id="totalEmprestimos">0</div>
            </div>
            <div class="status-card">
                <h3>Valor Total Devido</h3>
                <div id="valorTotalDevido">R$ 0,00</div>
            </div>
            <div class="status-card">
                <h3>Próximo Vencimento</h3>
                <div id="proximoVencimento">Nenhum</div>
            </div>
            <div class="status-card">
                <h3>Score</h3>
                <div id="scoreCliente">0</div>
            </div>
        </div>

        <div class="status-cards">
            <div class="status-card">
                <h3><i class="fas fa-money-bill-wave"></i> Margem Avulso</h3>
                <div id="margemAvulso">R$ 0,00</div>
                <small>Empréstimo de 20 a 30 dias</small>
            </div>
            <div class="status-card">
                <h3><i class="fas fa-calendar-alt"></i> Margem Parcelado</h3>
                <div id="margemParcelado">R$ 0,00</div>
                <small>Empréstimo em até 10x</small>
            </div>
            <div class="status-card">
                <h3><i class="fas fa-credit-card"></i> Margem Cartão</h3>
                <div id="margemCartao">R$ 0,00</div>
                <small>Empréstimo no cartão em até 12x</small>
            </div>
        </div>

        <div class="emprestimos-section">
            <h2>Meus Empréstimos</h2>
            <div id="listaEmprestimos">
                <!-- Empréstimos serão inseridos aqui -->
            </div>
        </div>

        <div class="emprestimos-section">
            <h2>Solicitações de Aumento de Margem</h2>
            <button onclick="abrirModalSolicitacao()" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nova Solicitação
            </button>
            <div id="listaSolicitacoes" class="mt-3">
                <!-- Solicitações serão inseridas aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de Pagamento -->
    <div id="modalPagamento" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Realizar Pagamento</h2>
            <div id="detalhesPagamento"></div>
            <form id="formPagamento">
                <div class="form-group">
                    <label>Forma de Pagamento</label>
                    <select id="formaPagamento" required>
                        <option value="pix">PIX</option>
                        <option value="boleto">Boleto</option>
                        <option value="transferencia">Transferência</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Comprovante</label>
                    <input type="file" id="comprovante" accept="image/*,.pdf" required>
                </div>
                <button type="submit" class="btn btn-primary">Enviar Pagamento</button>
            </form>
        </div>
    </div>

    <!-- Modal de Solicitação de Margem -->
    <div id="modalSolicitacao" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Solicitar Aumento de Margem</h2>
            <form id="formSolicitacao">
                <div class="form-group">
                    <label>Tipo de Margem</label>
                    <select id="tipoMargem" required>
                        <option value="avulso">Avulso</option>
                        <option value="parcelado">Parcelado</option>
                        <option value="cartao">Cartão</option>
                        <option value="emergencial">Emergencial</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Valor Solicitado</label>
                    <input type="text" id="valorSolicitado" required placeholder="R$ 0,00">
                </div>
                <div class="form-group">
                    <label>Motivo da Solicitação</label>
                    <textarea id="motivoSolicitacao" required rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Enviar Solicitação</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://sistema-emprestimo.onrender.com';
        let clienteData = null;

        // Verificar autenticação
        function verificarAuth() {
            const token = localStorage.getItem('clienteToken');
            if (!token) {
                window.location.href = 'cadastro.html';
                return;
            }
            clienteData = JSON.parse(localStorage.getItem('clienteData'));
            document.getElementById('nomeCliente').textContent = clienteData.nome;
        }

        // Carregar dados do cliente
        async function carregarDados() {
            try {
                const response = await fetch(`${API_URL}/api/clientes/${clienteData.id}/emprestimos`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('clienteToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    atualizarDashboard(data);
                    renderizarEmprestimos(data.emprestimos);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados');
            }
        }

        // Atualizar dashboard
        function atualizarDashboard(data) {
            document.getElementById('totalEmprestimos').textContent = data.total_emprestimos;
            document.getElementById('valorTotalDevido').textContent = formatarMoeda(data.valor_total_devido);
            document.getElementById('proximoVencimento').textContent = data.proximo_vencimento ? formatarData(data.proximo_vencimento) : 'Nenhum';
            document.getElementById('scoreCliente').textContent = data.score;
            
            // Atualizar margens
            document.getElementById('margemAvulso').textContent = formatarMoeda(data.margem_avulso);
            document.getElementById('margemParcelado').textContent = formatarMoeda(data.margem_parcelado);
            document.getElementById('margemCartao').textContent = formatarMoeda(data.margem_cartao);

            // Atualizar tipo de cliente
            const tipoClienteElement = document.getElementById('tipoCliente');
            tipoClienteElement.textContent = data.tipo_cliente;
            tipoClienteElement.className = `tipo-cliente tipo-${data.tipo_cliente}`;

            // Carregar solicitações
            carregarSolicitacoes();
        }

        // Renderizar empréstimos
        function renderizarEmprestimos(emprestimos) {
            const container = document.getElementById('listaEmprestimos');
            container.innerHTML = '';

            emprestimos.forEach(emp => {
                const card = document.createElement('div');
                card.className = 'emprestimo-card';
                
                const statusClass = emp.status_pagamento === 'em_dia' ? 'status-em-dia' : 
                                  emp.status_pagamento === 'atrasado' ? 'status-atrasado' : 
                                  'status-quitado';

                card.innerHTML = `
                    <div class="emprestimo-header">
                        <h3>Empréstimo #${emp.id}</h3>
                        <span class="status-badge ${statusClass}">
                            ${emp.status_pagamento.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    <div>
                        <p>Valor: ${formatarMoeda(emp.valor)}</p>
                        <p>Total com Juros: ${formatarMoeda(emp.total)}</p>
                        <p>Parcelas Pagas: ${emp.parcelas_pagas}/${emp.parcelas}</p>
                        <p>Próximo Vencimento: ${formatarData(emp.proxima_parcela)}</p>
                    </div>
                    <div class="parcelas-grid">
                        ${renderizarParcelas(emp.pagamentos)}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Renderizar parcelas
        function renderizarParcelas(pagamentos) {
            return pagamentos.map(pag => {
                const status = pag.status === 'pago' ? 'paga' :
                             new Date(pag.data_vencimento) < new Date() ? 'atrasada' : 'pendente';
                
                return `
                    <div class="parcela-card ${status}">
                        <div>Parcela ${pag.numero_parcela}</div>
                        <div>${formatarMoeda(pag.valor_parcela)}</div>
                        <div>${formatarData(pag.data_vencimento)}</div>
                        ${status === 'pendente' || status === 'atrasada' ? `
                            <button onclick="abrirModalPagamento(${pag.id})" class="btn btn-small">
                                Pagar
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Modal de pagamento
        function abrirModalPagamento(pagamentoId) {
            const modal = document.getElementById('modalPagamento');
            modal.style.display = 'block';
            modal.dataset.pagamentoId = pagamentoId;
        }

        // Fechar modal
        document.querySelector('.close').onclick = function() {
            document.getElementById('modalPagamento').style.display = 'none';
        }

        // Enviar pagamento
        document.getElementById('formPagamento').onsubmit = async function(e) {
            e.preventDefault();
            
            const pagamentoId = document.getElementById('modalPagamento').dataset.pagamentoId;
            const formData = new FormData();
            formData.append('forma_pagamento', document.getElementById('formaPagamento').value);
            formData.append('comprovante', document.getElementById('comprovante').files[0]);

            try {
                const response = await fetch(`${API_URL}/api/pagamentos/${pagamentoId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('clienteToken')}`
                    },
                    body: formData
                });

                if (response.ok) {
                    alert('Pagamento enviado com sucesso! Aguarde a confirmação.');
                    document.getElementById('modalPagamento').style.display = 'none';
                    carregarDados();
                } else {
                    alert('Erro ao enviar pagamento');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar pagamento');
            }
        }

        // Funções auxiliares
        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }

        // Carregar solicitações de margem
        async function carregarSolicitacoes() {
            try {
                const response = await fetch(`${API_URL}/api/clientes/${clienteData.id}/solicitacoes-margem`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('clienteToken')}`
                    }
                });

                if (response.ok) {
                    const solicitacoes = await response.json();
                    renderizarSolicitacoes(solicitacoes);
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        // Renderizar solicitações
        function renderizarSolicitacoes(solicitacoes) {
            const container = document.getElementById('listaSolicitacoes');
            container.innerHTML = '';

            solicitacoes.forEach(sol => {
                const card = document.createElement('div');
                card.className = 'emprestimo-card';
                
                card.innerHTML = `
                    <div class="emprestimo-header">
                        <h3>Solicitação de ${sol.tipo_margem.toUpperCase()}</h3>
                        <span class="status-badge status-${sol.status}">
                            ${sol.status.toUpperCase()}
                        </span>
                    </div>
                    <div>
                        <p>Valor Solicitado: ${formatarMoeda(sol.valor_solicitado)}</p>
                        <p>Data: ${formatarData(sol.created_at)}</p>
                        <p>Motivo: ${sol.motivo}</p>
                        ${sol.observacao ? `<p>Observação: ${sol.observacao}</p>` : ''}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Abrir modal de solicitação
        function abrirModalSolicitacao() {
            document.getElementById('modalSolicitacao').style.display = 'block';
        }

        // Máscara para valor solicitado
        document.getElementById('valorSolicitado').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = (parseInt(value) / 100).toFixed(2);
            
            if (!isNaN(value)) {
                value = value.replace('.', ',');
                value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                e.target.value = `R$ ${value}`;
            }
        });

        // Enviar solicitação
        document.getElementById('formSolicitacao').onsubmit = async function(e) {
            e.preventDefault();
            
            const dados = {
                tipo_margem: document.getElementById('tipoMargem').value,
                valor_solicitado: desformatarMoeda(document.getElementById('valorSolicitado').value),
                motivo: document.getElementById('motivoSolicitacao').value
            };

            try {
                const response = await fetch(`${API_URL}/api/clientes/${clienteData.id}/solicitacoes-margem`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('clienteToken')}`
                    },
                    body: JSON.stringify(dados)
                });

                if (response.ok) {
                    alert('Solicitação enviada com sucesso!');
                    document.getElementById('modalSolicitacao').style.display = 'none';
                    document.getElementById('formSolicitacao').reset();
                    carregarSolicitacoes();
                } else {
                    alert('Erro ao enviar solicitação');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar solicitação');
            }
        };

        // Função para carregar dados do cliente
        async function carregarDadosCliente() {
            try {
                const response = await fetch(`${API_URL}/api/clientes/perfil`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                const data = await response.json();
                atualizarNivel(data);
                atualizarBeneficios(data);
                carregarMedalhas();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // Função para atualizar nível
        function atualizarNivel(data) {
            const nivelNome = document.getElementById('nivelNome');
            const progressoNivel = document.getElementById('progressoNivel');
            const pontosProximo = document.getElementById('pontosProximo');

            nivelNome.textContent = data.nivel;
            
            // Calcular progresso para próximo nível
            const niveisScore = {
                'Bronze': 0,
                'Prata': 300,
                'Ouro': 600,
                'Diamante': 900
            };

            const nivelAtual = niveisScore[data.nivel];
            const proximoNivel = Object.entries(niveisScore).find(([nivel, score]) => score > data.score);
            
            if (proximoNivel) {
                const progresso = ((data.score - nivelAtual) / (proximoNivel[1] - nivelAtual)) * 100;
                progressoNivel.style.width = `${progresso}%`;
                pontosProximo.textContent = proximoNivel[1] - data.score;
            } else {
                progressoNivel.style.width = '100%';
                pontosProximo.textContent = 'Nível máximo atingido!';
            }
        }

        // Função para atualizar benefícios
        function atualizarBeneficios(data) {
            document.getElementById('descontoJuros').textContent = `${data.beneficios.desconto_juros}%`;
            document.getElementById('multiplicadorMargem').textContent = `${data.beneficios.multiplicador_margem}x`;
            document.getElementById('tempoAnalise').textContent = `${data.beneficios.tempo_analise_horas}h`;
        }

        // Função para carregar medalhas
        async function carregarMedalhas() {
            try {
                const response = await fetch(`${API_URL}/api/clientes/medalhas`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                const data = await response.json();
                const medalhasGrid = document.getElementById('medalhasGrid');
                medalhasGrid.innerHTML = '';

                data.forEach(medalha => {
                    const card = document.createElement('div');
                    card.className = `medalha-card ${medalha.conquistada ? '' : 'bloqueada'}`;
                    card.innerHTML = `
                        <i class="fas ${medalha.icone} medalha-icone"></i>
                        <h4>${medalha.nome}</h4>
                        <p>${medalha.descricao}</p>
                        ${medalha.conquistada ? `<small>Conquistada em: ${new Date(medalha.data_conquista).toLocaleDateString()}</small>` : ''}
                    `;
                    medalhasGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Erro ao carregar medalhas:', error);
            }
        }

        // Inicialização
        verificarAuth();
        carregarDados();
        carregarDadosCliente();
    </script>
</body>
</html> 